name: CI/CD Pipeline for QA System v1.0
on:
  push:
    branches: [main, develop]
    tags: [v1.0, latest]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20.x'
  REGISTRY: ghcr.io/your-org/qa-system
  DOCKER_BUILDKIT: docker/buildx
  ACTIONS_ALLOW_UNSECURE_COMMANDS: false
  TZ: UTC

jobs:
  # Security Scanning
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  # Code Quality Checks
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install flake8 black isort
          npm install -g eslint prettier
      
      - name: Run Python linting
        run: |
          flake8 agentic/ --max-line-length=88 --ignore=E203,W503
          black --check agentic/
          isort --check-only agentic/
      
      - name: Run JavaScript linting
        run: |
          eslint agentic/webgui/ --ext .js,.jsx,.ts,.tsx || true
          prettier --check agentic/webgui/ || true

  # Build and Test
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build containers
        run: |
          docker-compose -f agentic/docker-compose.yml build --no-cache
      
      - name: Run tests
        run: |
          cd agentic
          pip install -r requirements.txt
          pytest tests/ --cov=agents/ --cov=webgui --cov-report=xml || true
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./agentic/coverage.xml

  # Container Security Scan
  container-scan:
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Run Trivy on containers
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: |
            ghcr.io/your-org/qa-system/webgui:latest
            ghcr.io/your-org/qa-system/performance:latest
            ghcr.io/your-org/qa-system/security-compliance:latest
            ghcr.io/your-org/qa-system/resilience:latest
            ghcr.io/your-org/qa-system/user-experience:latest
            ghcr.io/your-org/qa-system/senior:latest
            ghcr.io/your-org/qa-system/junior:latest
            ghcr.io/your-org/qa-system/qa-manager:latest
          format: 'sarif'
          output: 'container-trivy-results.sarif'

  # Deploy to Staging
  deploy-staging:
    if: github.ref == 'refs/tags/v1.0'
    runs-on: ubuntu-latest
    needs: [security-scan, code-quality, build-and-test, container-scan]
    steps:
      - name: Deploy to staging
        run: |
          docker-compose -f agentic/docker-compose.staging.yml up -d
      
      - name: Verify staging deployment
        run: |
          sleep 30
          curl -f http://localhost:8000/health || true

  # Deploy to Production
  deploy-production:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: [security-scan, code-quality, build-and-test, container-scan]
    steps:
      - name: Deploy to production
        run: |
          docker-compose -f agentic/docker-compose.prod.yml up -d
      
      - name: Verify production deployment
        run: |
          sleep 30
          curl -f http://localhost:8080/health || true

  # Post-Deployment Verification
  post-deploy:
    needs: [deploy-staging, deploy-production]
    runs-on: ubuntu-latest
    if: always() && (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')
    steps:
      - name: Verify all services
        run: |
          docker-compose ps
      
      - name: Run health checks
        run: |
          curl -f http://localhost:8000/health || true
          curl -f http://localhost:8080/health || true
      
      - name: Run smoke tests
        run: |
          cd agentic
          python scripts/smoke_tests.py || true

  # Blue-Green Deployment (Optional)
  deploy-blue-green:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: [security-scan, code-quality, build-and-test, container-scan]
    steps:
      - name: Deploy to blue environment
        run: |
          docker-compose -f agentic/docker-compose.blue.yml up -d
      
      - name: Verify blue deployment
        run: |
          sleep 30
          curl -f http://blue.localhost:8080/health || true
      
      - name: Promote blue to green
        run: |
          docker-compose -f agentic/docker-compose.green.yml up -d
      
      - name: Switch to green environment
        run: |
          ./scripts/switch-to-green.sh || true
      
      - name: Verify green deployment
        run: |
          sleep 30
          curl -f http://localhost:8080/health || true