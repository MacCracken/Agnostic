name: CI/CD Pipeline for QA System v1.0
on:
  push:
    branches: [main, develop]
    tags: [v1.0, latest]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20.x'
  REGISTRY: ghcr.io/${{ github.repository_owner }}/qa-system
  DOCKER_BUILDKIT: docker/buildx
  ACTIONS_ALLOW_UNSECURE_COMMANDS: false
  TZ: UTC

jobs:
  # Security Scanning
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  # Code Quality Checks
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install flake8 black isort mypy ruff
          npm install -g eslint prettier || true
      
      - name: Run Python linting
        run: |
          # Check main directories (not just agentic/)
          ruff check agents/ config/ shared/ webgui/ --format=github
          black --check agents/ config/ shared/ webgui/
          isort --check-only agents/ config/ shared/ webgui/
          mypy agents/ config/ shared/ --ignore-missing-imports || true
      
      - name: Run type checking
        run: |
          mypy --strict agents/ config/ shared/ --ignore-missing-imports || true
      
      - name: Run JavaScript linting
        run: |
          eslint webgui/ --ext .js,.jsx,.ts,.tsx || true
          prettier --check webgui/ || true

  # Build and Test
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test-mode: [unit, integration]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt || echo "No dev requirements file"
          # Add Docker's official GPG key:
          sudo apt update
          sudo apt install ca-certificates curl
          sudo install -m 0755 -d /etc/apt/keyrings
          sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
          sudo chmod a+r /etc/apt/keyrings/docker.asc

          # Add the repository to Apt sources:
          sudo tee /etc/apt/sources.list.d/docker.sources <<EOF
Types: deb
URIs: https://download.docker.com/linux/ubuntu
Suites: $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}")
Components: stable
Signed-By: /etc/apt/keyrings/docker.asc
EOF

          sudo apt update
          sudo apt install docker docker-compose-plugin
      
      - name: Set up test environment
        run: |
          # Set up environment variables for testing
          echo "REDIS_HOST=localhost" >> $GITHUB_ENV
          echo "RABBITMQ_HOST=localhost" >> $GITHUB_ENV
          echo "LOG_LEVEL=DEBUG" >> $GITHUB_ENV
          
          # Start test services for integration tests
          if [ "${{ matrix.test-mode }}" == "integration" ]; then
            docker-compose -f docker-compose.test.yml up -d redis-test rabbitmq-test
            sleep 10
          fi
      
      - name: Run tests
        run: |
          python run_tests.py --mode ${{ matrix.test-mode }} --env $([ "${{ matrix.test-mode }}" == "integration" ] && echo "docker" || echo "mock")
      
      - name: Upload coverage reports
        if: matrix.test-mode == 'unit'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
      
      - name: Cleanup test services
        if: matrix.test-mode == 'integration'
        run: |
          docker-compose -f docker-compose.test.yml down -v || true

  # Container Build and Security Scan
  container-build:
    runs-on: ubuntu-latest
    needs: [code-quality, build-and-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build containers
        run: |
          # Build main containers
          docker-compose -f docker-compose.yml build --no-cache
          
          # Build test containers
          docker-compose -f docker-compose.test.yml build --no-cache
      
      - name: Test container health
        run: |
          # Test basic container functionality
          docker-compose -f docker-compose.yml up -d redis rabbitmq
          sleep 10
          
          # Check Redis connection
          docker-compose exec -T redis redis-cli ping
          
          # Check RabbitMQ connection  
          docker-compose exec -T rabbitmq rabbitmq-diagnostics ping
          
          docker-compose -f docker-compose.yml down
  
  # Container Security Scan
  container-scan:
    runs-on: ubuntu-latest
    needs: container-build
    steps:
      - name: Run Trivy on local containers
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: |
            qa-system_redis:latest
            qa-system_rabbitmq:latest
            qa-system_webgui:latest
          format: 'sarif'
          output: 'container-trivy-results.sarif'

  # Deploy to Staging
  deploy-staging:
    if: github.ref == 'refs/tags/v1.0'
    runs-on: ubuntu-latest
    needs: [security-scan, code-quality, build-and-test, container-scan]
    steps:
      - name: Deploy to staging
        run: |
          docker-compose -f agentic/docker-compose.staging.yml up -d
      
      - name: Verify staging deployment
        run: |
          sleep 30
          curl -f http://localhost:8000/health || true

  # Deploy to Production
  deploy-production:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: [security-scan, code-quality, build-and-test, container-scan]
    steps:
      - name: Deploy to production
        run: |
          docker-compose -f agentic/docker-compose.prod.yml up -d
      
      - name: Verify production deployment
        run: |
          sleep 30
          curl -f http://localhost:8080/health || true

  # Post-Deployment Verification
  post-deploy:
    needs: [deploy-staging, deploy-production]
    runs-on: ubuntu-latest
    if: always() && (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')
    steps:
      - name: Verify all services
        run: |
          docker-compose ps
      
      - name: Run health checks
        run: |
          curl -f http://localhost:8000/health || true
          curl -f http://localhost:8080/health || true
      
      - name: Run smoke tests
        run: |
          cd agentic
          python scripts/smoke_tests.py || true

  # Blue-Green Deployment (Optional)
  deploy-blue-green:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: [security-scan, code-quality, build-and-test, container-scan]
    steps:
      - name: Deploy to blue environment
        run: |
          docker-compose -f agentic/docker-compose.blue.yml up -d
      
      - name: Verify blue deployment
        run: |
          sleep 30
          curl -f http://blue.localhost:8080/health || true
      
      - name: Promote blue to green
        run: |
          docker-compose -f agentic/docker-compose.green.yml up -d
      
      - name: Switch to green environment
        run: |
          ./scripts/switch-to-green.sh || true
      
      - name: Verify green deployment
        run: |
          sleep 30
          curl -f http://localhost:8080/health || true
